<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BU Risk Score Race - Championship</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { min-height: 100vh; background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%); font-family: 'Rajdhani', sans-serif; padding: 20px 20px 100px 20px; position: relative; overflow-x: hidden; }
    .tab-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: linear-gradient(180deg, rgba(26,26,46,0.95) 0%, rgba(10,10,15,0.98) 100%); border-top: 1px solid rgba(255,255,255,0.1); z-index: 100; backdrop-filter: blur(10px); }
    .tab-btn { flex: 1; padding: 15px 20px; background: transparent; border: none; color: #666; font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 5px; border-top: 3px solid transparent; }
    .tab-btn:hover { color: #888; background: rgba(255,255,255,0.05); }
    .tab-btn.active { color: #FFD700; border-top-color: #FFD700; background: rgba(255,215,0,0.1); }
    .tab-btn .icon { font-size: 24px; }
    @keyframes confettiFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    @keyframes podiumRise { 0% { transform: translateY(100px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    .confetti-piece { position: fixed; animation: confettiFall linear forwards; z-index: 1001; }
    .podium-place { animation: podiumRise 0.8s ease-out forwards; }
    .header { text-align: center; margin-bottom: 30px; }
    .header-subtitle { font-size: 14px; color: #FF6B35; letter-spacing: 8px; margin-bottom: 10px; font-weight: 500; }
    .header-title { font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 900; margin: 0; font-family: 'Orbitron', sans-serif; background: linear-gradient(180deg, #fff 0%, #888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 4px; }
    .header-tracker { font-size: 16px; color: #666; margin-top: 10px; letter-spacing: 3px; }
    .current-month-badge { margin-top: 20px; padding: 10px 30px; background: rgba(255,107,53,0.2); border-radius: 30px; display: inline-block; border: 2px solid #FF6B35; font-size: 18px; color: #FF6B35; font-weight: 900; font-family: 'Orbitron', sans-serif; letter-spacing: 3px; }
    .main-container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 200px; gap: 20px; align-items: start; }
    .chart-container { background: rgba(255,255,255,0.02); border-radius: 20px; padding: 30px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .leaderboard { background: rgba(255,255,255,0.02); border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .leaderboard-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .leaderboard-label { font-size: 10px; color: #888; letter-spacing: 3px; margin-bottom: 5px; }
    .leaderboard-title { font-size: 14px; color: #fff; font-weight: 900; letter-spacing: 2px; font-family: 'Orbitron', sans-serif; }
    .leaderboard-item { display: flex; align-items: center; gap: 8px; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid transparent; transition: all 0.3s ease; }
    .leaderboard-item.leader { background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.4); }
    .rank-badge { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 900; font-family: 'Orbitron', sans-serif; flex-shrink: 0; }
    .leaderboard-avatar { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; }
    .leaderboard-info { flex: 1; min-width: 0; }
    .leaderboard-name { font-size: 9px; font-weight: 700; font-family: 'Orbitron', sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .leaderboard-score-row { display: flex; align-items: center; gap: 6px; }
    .leaderboard-score { font-size: 13px; color: #fff; font-weight: 900; font-family: 'Orbitron', sans-serif; }
    .rank-change { font-size: 9px; font-weight: 700; }
    .rank-change.up { color: #22c55e; }
    .rank-change.down { color: #ef4444; }
    .progress-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .progress-label { font-size: 9px; color: #666; letter-spacing: 1px; }
    .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #FFD700, #FF6B35); border-radius: 2px; transition: width 0.5s ease; }
    .begin-race-container { display: flex; justify-content: center; margin-top: 30px; }
    .begin-race-btn { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 12px; padding: 16px 48px; font-size: 18px; font-weight: 900; font-family: 'Orbitron', sans-serif; color: #fff; cursor: pointer; letter-spacing: 2px; box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4); transition: all 0.3s ease; text-transform: uppercase; }
    .begin-race-btn:hover { transform: scale(1.05); box-shadow: 0 6px 30px rgba(34, 197, 94, 0.6); }
    .legend-note { text-align: center; margin-top: 30px; color: #666; font-size: 12px; letter-spacing: 2px; }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    .close-btn { margin-top: 50px; background: transparent; border: 2px solid #FFD700; border-radius: 8px; padding: 12px 30px; font-size: 14px; font-weight: 700; font-family: 'Orbitron', sans-serif; color: #FFD700; cursor: pointer; letter-spacing: 2px; transition: all 0.3s ease; }
    .close-btn:hover { background: #FFD700; color: #000; }
    .close-btn.teal { border-color: #00D4AA; color: #00D4AA; }
    .close-btn.teal:hover { background: #00D4AA; color: #000; }
    .podium-container { display: flex; align-items: flex-end; justify-content: center; gap: 20px; }
    .standings-list { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 30px; min-width: 350px; }
    .standings-item { display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
    .standings-item.leader { background: rgba(255,215,0,0.15); border: 2px solid rgba(255,215,0,0.4); }
    .standings-rank { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 900; font-family: 'Orbitron', sans-serif; }
    .settings-container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .settings-card { background: rgba(255,255,255,0.02); border-radius: 16px; padding: 30px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .settings-title { font-family: 'Orbitron', sans-serif; font-size: 18px; color: #FFD700; margin-bottom: 20px; letter-spacing: 2px; }
    .settings-description { color: #888; font-size: 14px; margin-bottom: 20px; line-height: 1.6; }
    .upload-zone { border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
    .upload-zone:hover { border-color: #FFD700; background: rgba(255,215,0,0.05); }
    .upload-zone.dragover { border-color: #22c55e; background: rgba(34,197,94,0.1); }
    .upload-icon { font-size: 48px; margin-bottom: 15px; }
    .upload-text { color: #888; font-size: 14px; }
    .upload-text strong { color: #FFD700; }
    .btn { padding: 12px 24px; border-radius: 8px; font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; letter-spacing: 1px; border: none; }
    .btn-primary { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; }
    .btn-primary:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(255,215,0,0.4); }
    .btn-secondary { background: transparent; border: 2px solid #666; color: #888; }
    .btn-secondary:hover { border-color: #888; color: #fff; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
    .alert-success { background: rgba(34,197,94,0.2); border: 1px solid #22c55e; color: #22c55e; }
    .alert-error { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; color: #ef4444; }
    .data-preview { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-top: 20px; overflow-x: auto; }
    .data-preview table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .data-preview th, .data-preview td { padding: 8px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .data-preview th { color: #FFD700; font-family: 'Orbitron', sans-serif; font-weight: 700; }
    .data-preview td { color: #ccc; }
    .no-data { text-align: center; padding: 60px 20px; color: #666; }
    .no-data-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
    #fileInput { display: none; }
  </style>
</head>
<body>
  <div id="app"></div>
  <nav class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('2026')"><span class="icon">üèéÔ∏è</span><span>2026 Race</span></button>
    <button class="tab-btn" onclick="switchTab('2025')"><span class="icon">üèÅ</span><span>2025 Race</span></button>
    <button class="tab-btn" onclick="switchTab('settings')"><span class="icon">‚öôÔ∏è</span><span>Settings</span></button>
  </nav>
  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
  <script>
    const defaultData = {
      '2026': { bus: [{name:'US RET',color:'#00BFFF'},{name:'CAN RET',color:'#7B68EE'},{name:'ASIA',color:'#FF1493'},{name:'US RETAIL',color:'#FF6B35'},{name:'CAN RETAIL',color:'#00D4AA'}], months: ['Jan','Feb','Mar','Apr','May'], scores: {'US RET':{Jan:98,Feb:97.5,Mar:99.1,Apr:98.65,May:97.9},'CAN RET':{Jan:98.07,Feb:99.25,Mar:98.9,Apr:97.8,May:99.45},'ASIA':{Jan:82.88,Feb:85.4,Mar:88.75,Apr:91.2,May:94.3},'US RETAIL':{Jan:99.99,Feb:98.8,Mar:97.25,Apr:99.5,May:98.2},'CAN RETAIL':{Jan:99.02,Feb:97.6,Mar:98.45,Apr:99.15,May:99.6}}},
      '2025': { bus: [{name:'US RET',color:'#00BFFF'},{name:'CAN RET',color:'#7B68EE'},{name:'ASIA',color:'#FF1493'},{name:'US RETAIL',color:'#FF6B35'},{name:'CAN RETAIL',color:'#00D4AA'}], months: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], scores: {'US RET':{Jan:96.5,Feb:97.2,Mar:98.1,Apr:97.8,May:98.5,Jun:99.1,Jul:98.7,Aug:99.3,Sep:98.9,Oct:99.5,Nov:99.2,Dec:99.6},'CAN RET':{Jan:97.3,Feb:98.4,Mar:97.9,Apr:98.8,May:99.2,Jun:98.6,Jul:99.4,Aug:98.9,Sep:99.6,Oct:99.1,Nov:99.7,Dec:99.8},'ASIA':{Jan:80.5,Feb:82.3,Mar:84.6,Apr:86.9,May:89.2,Jun:91.5,Jul:93.8,Aug:95.1,Sep:96.4,Oct:97.2,Nov:98,Dec:98.5},'US RETAIL':{Jan:98.8,Feb:98.2,Mar:99.1,Apr:98.5,May:99.3,Jun:98.7,Jul:99.5,Aug:99.1,Sep:98.8,Oct:99.6,Nov:99.3,Dec:99.4},'CAN RETAIL':{Jan:97.9,Feb:98.6,Mar:98.2,Apr:99.1,May:98.8,Jun:99.4,Jul:99,Aug:99.5,Sep:99.2,Oct:99.7,Nov:99.4,Dec:99.5}}}
    };
    
    // localStorage functions
    const STORAGE_KEY = 'buRaceData';
    function saveToStorage(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(raceDataStore));console.log('Data saved to localStorage');}catch(e){console.error('Failed to save:',e);}}
    function loadFromStorage(){try{const saved=localStorage.getItem(STORAGE_KEY);if(saved){raceDataStore=JSON.parse(saved);console.log('Data loaded from localStorage');return true;}}catch(e){console.error('Failed to load:',e);}return false;}
    function clearStorage(){localStorage.removeItem(STORAGE_KEY);console.log('localStorage cleared');}
    
    // Initialize: load from localStorage or use default
    let raceDataStore = JSON.parse(JSON.stringify(defaultData));
    loadFromStorage();
    
    let currentTab = '2026', currentAlert = null, raceAudio = null, applauseAudio = null;
    let raceState = {'2025':{started:false,monthIndex:-1,progress:0,animated:false,celebration:false,animating:false},'2026':{started:false,monthIndex:-1,progress:0,animated:false,celebration:false,animating:false}};
    const chartWidth=900,chartHeight=400,padding={top:60,right:120,bottom:40,left:120};
    const graphWidth=chartWidth-padding.left-padding.right,graphHeight=chartHeight-padding.top-padding.bottom;

    function switchTab(tab){
      // Reset race for the tab we're leaving (if it was a race tab)
      if(currentTab==='2025'||currentTab==='2026'){
        raceState[currentTab]={started:false,monthIndex:-1,progress:0,animated:false,celebration:false,animating:false};
      }
      stopRaceSound();
      stopApplause();
      currentTab=tab;
      document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(tab==='2026'&&i===0)||(tab==='2025'&&i===1)||(tab==='settings'&&i===2)));
      render();
    }
    const avatarCache={};
    function getDefaultAvatar(c){return'data:image/svg+xml;base64,'+btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="#2a2a40"/><circle cx="50" cy="35" r="18" fill="${c}"/><path d="M50 58c20 0 32 12 32 28v14H18V86c0-16 12-28 32-28z" fill="${c}"/></svg>`);}
    function getAvatar(buName,color){const key=buName.replace(/\s+/g,'_').toLowerCase();if(avatarCache[key])return avatarCache[key];const img=new Image();const path=`images/${key}.png`;img.onload=()=>{avatarCache[key]=path;render();};img.onerror=()=>{avatarCache[key]=getDefaultAvatar(color);};img.src=path;return avatarCache[key]||getDefaultAvatar(color);}
    function easeOutCubic(t){return 1-Math.pow(1-t,3);}
    function getRankInMonth(y,bu,m){const d=raceDataStore[y];return d.bus.map(b=>({name:b.name,score:d.scores[b.name]?.[m]||0})).sort((a,b)=>b.score-a.score).findIndex(s=>s.name===bu)+1;}
    function getCurrentStandings(y){const d=raceDataStore[y],m=d.months[d.months.length-1];return d.bus.map(b=>({name:b.name,color:b.color,score:d.scores[b.name]?.[m]||0})).sort((a,b)=>b.score-a.score);}
    function getInterpolatedStandings(y){const s=raceState[y],d=raceDataStore[y];if(!s.started||s.monthIndex<0)return d.bus.map(b=>({name:b.name,color:b.color,score:0}));const e=easeOutCubic(s.progress);return d.bus.map(b=>{let sc=s.monthIndex===0?(d.scores[b.name]?.[d.months[0]]||0)*e:(d.scores[b.name]?.[d.months[s.monthIndex-1]]||0)+((d.scores[b.name]?.[d.months[s.monthIndex]]||0)-(d.scores[b.name]?.[d.months[s.monthIndex-1]]||0))*e;return{name:b.name,color:b.color,score:sc};}).sort((a,b)=>b.score-a.score);}
    function getX(i,t){return padding.left+(i/Math.max(t-1,1))*graphWidth;}
    function getY(i,t){return padding.top+(i*(graphHeight/t))+(graphHeight/t)/2;}
    function startRaceSound(){try{if(!raceAudio){raceAudio=new Audio('sounds/race.mp3');raceAudio.loop=true;raceAudio.volume=0.5;}raceAudio.currentTime=0;raceAudio.play().catch(()=>{});}catch(e){}}
    function stopRaceSound(){if(raceAudio){raceAudio.pause();raceAudio.currentTime=0;}}
    function startApplause(){try{if(!applauseAudio){applauseAudio=new Audio('sounds/applause.mp3');applauseAudio.volume=0.6;}applauseAudio.currentTime=0;applauseAudio.play().catch(()=>{});}catch(e){}}
    function stopApplause(){if(applauseAudio){applauseAudio.pause();applauseAudio.currentTime=0;}}
    function startRace(y){raceState[y]={started:true,monthIndex:0,progress:0,animated:false,celebration:false,animating:true};startRaceSound();animateRace(y);}
    function restartRace(y){raceState[y]={started:false,monthIndex:-1,progress:0,animated:false,celebration:false,animating:false};render();}
    function animateRace(y){const d=raceDataStore[y],s=raceState[y],dur=d.months.length<=2?9000:7000;let st=null;function anim(ts){if(!s.animating||currentTab!==y){s.animating=false;return;}if(!st)st=ts;s.progress=Math.min((ts-st)/dur,1);render();if(s.progress<1)requestAnimationFrame(anim);else if(s.monthIndex<d.months.length-1){s.monthIndex++;s.progress=0;st=null;requestAnimationFrame(anim);}else{s.animated=true;s.animating=false;stopRaceSound();startApplause();if(d.months.length>=12)s.celebration=true;render();}}requestAnimationFrame(anim);}
    function closeOverlay(y){raceState[y].celebration=false;raceState[y].animated=false;stopApplause();render();}
    function triggerFileUpload(){document.getElementById('fileInput').click();}
    function handleFileUpload(e){const f=e.target.files[0];if(!f)return;console.log('File selected:',f.name);const r=new FileReader();r.onload=function(ev){try{const data=new Uint8Array(ev.target.result),wb=XLSX.read(data,{type:'array'});console.log('Sheet names found:',wb.SheetNames);let hasData=false;const errs=[];['2025','2026'].forEach(y=>{if(wb.SheetNames.includes(y)){console.log('Processing sheet:',y);const res=parseSheet(wb.Sheets[y],y);console.log('Parse result for',y,':',res);if(res.success){raceDataStore[y]=res.data;raceState[y]={started:false,monthIndex:-1,progress:0,animated:false,celebration:false,animating:false};hasData=true;}else errs.push(`Sheet "${y}": ${res.error}`);}});if(errs.length)showAlert('error','Validation Errors:\n'+errs.join('\n'));else if(hasData){saveToStorage();showAlert('success','Data loaded & saved! Found: '+['2025','2026'].filter(y=>wb.SheetNames.includes(y)).join(', '));}else showAlert('error','No valid sheets. Include sheets named "2025" and/or "2026".');render();}catch(err){console.error('Upload error:',err);showAlert('error','Error: '+err.message);}};r.readAsArrayBuffer(f);e.target.value='';}
    function parseSheet(sh,y){try{const j=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});console.log('Raw sheet data:',j);if(j.length<2)return{success:false,error:'Empty sheet'};const h=j[0];console.log('Headers:',h);if(!h||h.length<3)return{success:false,error:'Need: BU, Color, Month columns'};const h0=String(h[0]||'').trim().toUpperCase();const h1=String(h[1]||'').trim().toUpperCase();if(h0!=='BU')return{success:false,error:`First column must be "BU" (found "${h[0]}")`};if(h1!=='COLOR')return{success:false,error:`Second column must be "Color" (found "${h[1]}")`};const vm=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'],ms=[];for(let i=2;i<h.length;i++){if(!h[i]||String(h[i]).trim()==='')continue;const m=String(h[i]).trim().toUpperCase().substring(0,3);if(!vm.includes(m))return{success:false,error:`Invalid month "${h[i]}" in column ${i+1}`};ms.push(m.charAt(0)+m.slice(1).toLowerCase());}console.log('Months parsed:',ms);if(ms.length===0)return{success:false,error:'No valid month columns found'};const bus=[],scores={};for(let i=1;i<j.length;i++){const row=j[i];if(!row||!row[0]||String(row[0]).trim()==='')continue;const bn=String(row[0]).trim(),cl=String(row[1]||'#888888').trim();if(!/^#[0-9A-Fa-f]{6}$/.test(cl))return{success:false,error:`Invalid color "${cl}" for "${bn}" row ${i+1}. Use format #RRGGBB`};bus.push({name:bn,color:cl});scores[bn]={};for(let k=0;k<ms.length;k++){const v=row[k+2],sc=parseFloat(v);if(v!==undefined&&v!==''&&!isNaN(sc)){if(sc<0||sc>100)return{success:false,error:`Score ${sc} out of range (0-100) for "${bn}" in ${ms[k]}`};scores[bn][ms[k]]=sc;}}}console.log('BUs parsed:',bus);console.log('Scores parsed:',scores);if(!bus.length)return{success:false,error:'No BU data found'};return{success:true,data:{bus,months:ms,scores}};}catch(e){console.error('Parse error:',e);return{success:false,error:e.message};}}
    function downloadTemplate(){const wb=XLSX.utils.book_new();['2025','2026'].forEach(y=>{const d=[['BU','Color','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],['US RET','#00BFFF',98,97.5,99.1,'','','','','','','','',''],['CAN RET','#7B68EE',98.07,99.25,98.9,'','','','','','','','',''],['ASIA','#FF1493',82.88,85.4,88.75,'','','','','','','','',''],['US RETAIL','#FF6B35',99.99,98.8,97.25,'','','','','','','','',''],['CAN RETAIL','#00D4AA',99.02,97.6,98.45,'','','','','','','','','']];const ws=XLSX.utils.aoa_to_sheet(d);ws['!cols']=[{wch:15},{wch:10},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8},{wch:8}];XLSX.utils.book_append_sheet(wb,ws,y);});XLSX.writeFile(wb,'race_data_template.xlsx');}
    function showAlert(t,m){currentAlert={type:t,message:m};render();if(t==='success')setTimeout(()=>{currentAlert=null;render();},5000);}
    function dismissAlert(){currentAlert=null;render();}
    function resetToDefault(){clearStorage();raceDataStore=JSON.parse(JSON.stringify(defaultData));raceState={'2025':{started:false,monthIndex:-1,progress:0,animated:false,celebration:false,animating:false},'2026':{started:false,monthIndex:-1,progress:0,animated:false,celebration:false,animating:false}};showAlert('success','Reset to defaults & cleared saved data');}
    function generateConfetti(){const cols=['#FFD700','#FF6B35','#00D4AA','#7B68EE','#00BFFF','#FF1493','#fff'];let h='';for(let i=0;i<150;i++)h+=`<div class="confetti-piece" style="left:${Math.random()*100}%;top:${-10-Math.random()*20}%;width:${5+Math.random()*10}px;height:${5+Math.random()*10}px;background:${cols[Math.floor(Math.random()*cols.length)]};border-radius:${i%2?'0':'50%'};animation-delay:${Math.random()*2}s;animation-duration:${3+Math.random()*2}s"></div>`;return h;}
    function renderRace(y){const d=raceDataStore[y],s=raceState[y];if(!d||!d.bus||!d.bus.length)return`<div class="no-data"><div class="no-data-icon">üìä</div><div style="font-size:18px">No data for ${y}</div><div style="font-size:14px;color:#555">Go to Settings to upload data</div></div>`;
      const am=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],iC=d.months.length>=12,dp=['Start',...d.months];if(!iC&&d.months.length<12)dp.push(am[d.months.length]);
      const lh=graphHeight/d.bus.length,lg=8,st=getCurrentStandings(y),ip=getInterpolatedStandings(y),rp={1:1,2:.82,3:.75,4:.65,5:.55};let svg='';
      d.bus.forEach((bu,idx)=>{const rk=s.started&&s.monthIndex>=0?getRankInMonth(y,bu.name,d.months[s.monthIndex]):null,isL=rk===1;const fl=isL?'rgba(255,215,0,0.08)':(idx%2?'rgba(255,255,255,0.04)':'rgba(255,255,255,0.02)'),sk=isL?'rgba(255,215,0,0.4)':`${bu.color}30`;const py=padding.top+idx*lh+lg/2,ly=getY(idx,d.bus.length);svg+=`<rect x="${padding.left-10}" y="${py}" width="${graphWidth+20}" height="${lh-lg}" fill="${fl}" rx="8"/><rect x="${padding.left-10}" y="${py}" width="${graphWidth+20}" height="${lh-lg}" fill="none" stroke="${sk}" stroke-width="${isL?2:1}" rx="8"/>`;if(isL)svg+=`<text x="${padding.left-60}" y="${ly-15}" fill="#FFD700" font-size="16" text-anchor="end">üèÜ</text>`;svg+=`<text x="${padding.left-40}" y="${ly}" fill="${isL?'#FFD700':bu.color}" font-size="15" font-weight="900" text-anchor="end" dominant-baseline="middle" font-family="Orbitron,sans-serif">${bu.name}</text>`;});
      dp.forEach((p,i)=>{const isS=p==='Start',hD=isS||d.months.includes(p),x=getX(i,dp.length);svg+=`<line x1="${x}" y1="${padding.top-10}" x2="${x}" y2="${padding.top+graphHeight+10}" stroke="${hD?'rgba(255,255,255,0.15)':'rgba(255,255,255,0.05)'}" stroke-dasharray="${hD?'none':'5,5'}"/><text x="${x}" y="${padding.top-25}" fill="${isS?'#22c55e':(hD?'#fff':'#444')}" font-size="${isS?12:14}" text-anchor="middle" font-family="Orbitron,sans-serif" font-weight="700">${isS?'üö¶ START':p}</text>`;if(!hD&&!isS)svg+=`<text x="${x}" y="${padding.top-10}" fill="#333" font-size="10" text-anchor="middle">TBD</text>`;});
      d.bus.forEach((bu,bi)=>{const sx=getX(0,dp.length),sy=getY(bi,d.bus.length),av=getAvatar(bu.name,bu.color);let path=`M ${sx} ${sy}`,ax=sx;if(s.started&&s.monthIndex>=0){for(let i=0;i<s.monthIndex;i++){const m=d.months[i],rk=getRankInMonth(y,bu.name,m),pi=dp.indexOf(m),px=getX(pi-1,dp.length),mx=getX(pi,dp.length);path+=` L ${px+(rp[rk]||.55)*(mx-px)*.85} ${sy}`;}const m=d.months[s.monthIndex],rk=getRankInMonth(y,bu.name,m),pi=dp.indexOf(m),ppx=getX(pi-1,dp.length),mx=getX(pi,dp.length),tx=ppx+(rp[rk]||.55)*(mx-ppx)*.85;let lsx=sx;if(s.monthIndex>0){const pm=d.months[s.monthIndex-1],pr=getRankInMonth(y,bu.name,pm),ppi=dp.indexOf(pm),pppx=getX(ppi-1,dp.length),pmx=getX(ppi,dp.length);lsx=pppx+(rp[pr]||.55)*(pmx-pppx)*.85;}ax=lsx+(tx-lsx)*easeOutCubic(s.progress);path+=` L ${ax} ${sy}`;}
        svg+=`<path d="${path}" fill="none" stroke="${bu.color}" stroke-width="3" stroke-linecap="round" style="filter:drop-shadow(0 0 6px ${bu.color})"/>`;const iS=ip.find(x=>x.name===bu.name),iR=ip.indexOf(iS)+1,isL=iR===1&&s.started&&s.monthIndex>=0,as=isL?28:24;if(isL)svg+=`<circle cx="${ax}" cy="${sy}" r="38" fill="rgba(255,215,0,0.15)"/>`;svg+=`<circle cx="${ax}" cy="${sy}" r="${isL?34:30}" fill="${bu.color}20"/><circle cx="${ax}" cy="${sy}" r="${as}" fill="#1a1a2e" stroke="${isL?'#FFD700':bu.color}" stroke-width="${isL?4:3}"/><clipPath id="c${y}${bi}"><circle cx="${ax}" cy="${sy}" r="${as-3}"/></clipPath><image href="${av}" x="${ax-as+3}" y="${sy-as+3}" width="${(as-3)*2}" height="${(as-3)*2}" clip-path="url(#c${y}${bi})"/>`;
        if(s.started&&s.monthIndex>=0){const bc={1:'#FFD700',2:'#C0C0C0',3:'#CD7F32'};svg+=`<circle cx="${ax+(isL?22:18)}" cy="${sy-(isL?22:18)}" r="14" fill="${bc[iR]||'#444'}" stroke="#1a1a2e" stroke-width="2"/><text x="${ax+(isL?22:18)}" y="${sy-(isL?18:14)}" fill="${iR<=3?'#000':'#fff'}" font-size="12" font-weight="900" text-anchor="middle" font-family="Orbitron,sans-serif">${iR}</text>`;if(isL)svg+=`<text x="${ax}" y="${sy-42}" font-size="24" text-anchor="middle">üëë</text>`;svg+=`<rect x="${ax+(isL?32:28)}" y="${sy-12}" width="55" height="24" rx="4" fill="${isL?'#FFD700':bu.color}"/><text x="${ax+(isL?59:55)}" y="${sy+4}" fill="#000" font-size="11" font-weight="700" text-anchor="middle" font-family="Orbitron,sans-serif">${(iS?.score||0).toFixed(2)}</text>`;}});
      svg+=`<defs><pattern id="ck${y}" width="8" height="8" patternUnits="userSpaceOnUse"><rect width="4" height="4" fill="rgba(255,255,255,0.3)"/><rect x="4" y="4" width="4" height="4" fill="rgba(255,255,255,0.3)"/><rect x="4" width="4" height="4" fill="rgba(0,0,0,0.3)"/><rect y="4" width="4" height="4" fill="rgba(0,0,0,0.3)"/></pattern></defs><rect x="${padding.left+graphWidth+10}" y="${padding.top}" width="15" height="${graphHeight}" fill="url(#ck${y})" opacity="0.6" rx="2"/><text x="${padding.left+graphWidth+17}" y="${padding.top-10}" fill="#666" font-size="14" text-anchor="middle">üèÅ</text>`;
      let lb='';ip.forEach((bu,i)=>{const pm=s.monthIndex>0?d.months[s.monthIndex-1]:null,pr=pm?getRankInMonth(y,bu.name,pm):i+1,ch=pr-(i+1),bc={0:'#FFD700',1:'#C0C0C0',2:'#CD7F32'},isL=s.started&&s.monthIndex>=0&&i===0,cfg=d.bus.find(b=>b.name===bu.name);lb+=`<div class="leaderboard-item ${isL?'leader':''}"><div class="rank-badge" style="background:${s.started&&s.monthIndex>=0?bc[i]||'#333':'#333'};color:${s.started&&s.monthIndex>=0&&i<3?'#000':'#666'}">${i+1}</div><img src="${getAvatar(bu.name,cfg?.color||'#888')}" class="leaderboard-avatar" style="border:2px solid ${cfg?.color||'#888'}"><div class="leaderboard-info"><div class="leaderboard-name" style="color:${isL?'#FFD700':cfg?.color||'#888'}">${bu.name}</div><div class="leaderboard-score-row"><span class="leaderboard-score">${s.started&&s.monthIndex>=0?bu.score.toFixed(2):'‚Äî'}</span>${s.started&&s.monthIndex>0&&ch?`<span class="rank-change ${ch>0?'up':'down'}">${ch>0?'‚ñ≤'+ch:'‚ñº'+Math.abs(ch)}</span>`:''}</div></div>${isL?'<div style="font-size:14px">üëë</div>':''}</div>`;});
      let h=`<div class="header"><div class="header-subtitle">üèÅ ${y} CHAMPIONSHIP üèÅ</div><h1 class="header-title">Risk Score Race</h1><div class="header-tracker">BUSINESS UNIT MONTHLY TRACKER</div>${s.started&&s.monthIndex>=0?`<div class="current-month-badge">üìÖ ${d.months[s.monthIndex].toUpperCase()} ${y}</div>`:''}</div><div class="main-container"><div class="chart-container"><svg width="100%" viewBox="0 0 ${chartWidth} ${chartHeight}" style="overflow:visible;display:block">${svg}</svg></div><div class="leaderboard"><div class="leaderboard-header"><div class="leaderboard-label">${s.started&&s.monthIndex>=0?'LIVE':'CURRENT'}</div><div class="leaderboard-title">üèÜ STANDINGS</div></div>${lb}<div class="progress-section"><div class="progress-label">MONTH ${s.started&&s.monthIndex>=0?s.monthIndex+1:0} OF 12</div><div class="progress-bar"><div class="progress-fill" style="width:${((s.started&&s.monthIndex>=0?s.monthIndex+1:0)/12)*100}%"></div></div></div></div></div>${!s.started?`<div class="begin-race-container"><button class="begin-race-btn" onclick="startRace('${y}')">üèÅ Begin Race</button></div>`:(s.animated?`<div class="begin-race-container"><button class="begin-race-btn" onclick="restartRace('${y}')" style="background:linear-gradient(135deg,#FF6B35 0%,#ff4500 100%);box-shadow:0 4px 20px rgba(255,107,53,0.4)">üîÑ Restart Race</button></div>`:'')}<div class="legend-note">${iC&&s.animated?'üèÜ RACE COMPLETE':(s.started?'üèéÔ∏è RACING...':'üèéÔ∏è READY ‚Ä¢ '+d.months.length+' MONTHS')}</div>`;
      if(s.animated&&d.months.length<12){const nm=am[d.months.length]||'TBD';h+=`<div class="overlay"><div style="text-align:center;margin-bottom:40px"><div style="font-size:60px;margin-bottom:10px">üìä</div><h2 style="font-family:Orbitron,sans-serif;font-size:36px;font-weight:900;color:#00D4AA;letter-spacing:4px">CURRENT STANDINGS</h2><p style="font-size:18px;color:#888;letter-spacing:3px;margin-top:10px">${d.months.length} OF 12 MONTHS COMPLETE</p></div><div class="standings-list">${st.map((bu,i)=>{const cfg=d.bus.find(b=>b.name===bu.name),bc={0:'#FFD700',1:'#C0C0C0',2:'#CD7F32'};return`<div class="standings-item ${!i?'leader':''}"><div class="standings-rank" style="background:${bc[i]||'#333'};color:${i<3?'#000':'#666'}">${i+1}</div><img src="${getAvatar(bu.name,cfg?.color||'#888')}" style="width:40px;height:40px;border-radius:50%;border:3px solid ${cfg?.color||'#888'}"><div class="standings-name" style="color:${!i?'#FFD700':cfg?.color||'#888'}">${bu.name}</div><div class="standings-score" style="font-size:18px;color:#fff;font-weight:900;font-family:Orbitron,sans-serif">${bu.score.toFixed(2)}</div>${!i?'<div style="font-size:20px">üëë</div>':''}</div>`;}).join('')}</div><p style="font-size:14px;color:#666;margin-top:30px;letter-spacing:2px">üèéÔ∏è NEXT: ${nm.toUpperCase()} ${y}</p><button class="close-btn teal" onclick="closeOverlay('${y}')">CLOSE</button></div>`;}
      if(s.celebration){h+=generateConfetti();h+=`<div class="overlay"><div style="text-align:center;margin-bottom:40px;animation:bounce 1s ease-in-out infinite"><div style="font-size:80px;margin-bottom:10px">üèÜ</div><h2 style="font-family:Orbitron,sans-serif;font-size:36px;font-weight:900;color:#FFD700;letter-spacing:4px">RACE COMPLETE!</h2><p style="font-size:18px;color:#888;letter-spacing:3px;margin-top:10px">${y} CHAMPIONSHIP FINAL</p></div><div class="podium-container">${[1,0,2].map(i=>{const bu=st[i];if(!bu)return'';const cfg=d.bus.find(b=>b.name===bu.name),sz=[{w:80,h:120,f:48,c:'#C0C0C0',d:.3,g:''},{w:100,h:160,f:64,c:'#FFD700',d:.1,g:'box-shadow:0 0 30px rgba(255,215,0,0.5)'},{w:70,h:90,f:40,c:'#CD7F32',d:.5,g:''}][i===0?1:i===1?0:2];return`<div class="podium-place" style="animation-delay:${sz.d}s;opacity:0;text-align:center">${i===0?'<div style="font-size:40px;margin-bottom:10px;animation:bounce .5s ease-in-out infinite">üëë</div>':''}<img src="${getAvatar(bu.name,cfg?.color||'#888')}" style="width:${sz.w}px;height:${sz.w}px;border-radius:50%;border:4px solid ${sz.c};margin-bottom:15px;${sz.g}"><div style="font-family:Orbitron,sans-serif;font-weight:700;color:${i===0?'#FFD700':'#fff'};font-size:${i===0?16:i===1?14:12}px;margin-bottom:5px">${bu.name}</div><div style="font-family:Orbitron,sans-serif;font-weight:900;color:${sz.c};font-size:${i===0?24:i===1?18:16}px;margin-bottom:15px">${bu.score.toFixed(2)}</div><div style="width:${sz.h}px;height:${sz.h}px;background:linear-gradient(180deg,${sz.c} 0%,${i===0?'#B8860B':i===1?'#808080':'#8B4513'} 100%);border-radius:10px 10px 0 0;display:flex;align-items:center;justify-content:center;font-family:Orbitron,sans-serif;font-weight:900;color:#fff;font-size:${sz.f}px">${i===0?1:i===1?2:3}</div></div>`;}).join('')}</div><button class="close-btn" onclick="closeOverlay('${y}')">CLOSE</button></div>`;}
      return h;}
    function renderSettings(){const hasSaved=localStorage.getItem(STORAGE_KEY)!==null;let p25='',p26='';['2025','2026'].forEach(y=>{const d=raceDataStore[y];if(d&&d.bus.length){let rows=d.bus.map(bu=>`<tr><td>${bu.name}</td><td><span style="display:inline-block;width:20px;height:20px;background:${bu.color};border-radius:4px;vertical-align:middle"></span> ${bu.color}</td>${d.months.map(m=>`<td>${d.scores[bu.name]?.[m]?.toFixed(2)||'-'}</td>`).join('')}</tr>`).join('');const t=`<table><thead><tr><th>BU</th><th>Color</th>${d.months.map(m=>`<th>${m}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table>`;if(y==='2025')p25=t;else p26=t;}});
      return`<div class="settings-container"><div class="header"><div class="header-subtitle">‚öôÔ∏è SETTINGS ‚öôÔ∏è</div><h1 class="header-title">Data Management</h1><div class="header-tracker">UPLOAD AND MANAGE RACE DATA</div></div>${currentAlert?`<div class="alert alert-${currentAlert.type}"><span>${currentAlert.type==='success'?'‚úÖ':'‚ùå'}</span><span style="flex:1;white-space:pre-wrap">${currentAlert.message}</span><button onclick="dismissAlert()" style="background:none;border:none;color:inherit;cursor:pointer;font-size:18px">√ó</button></div>`:''}<div class="settings-card"><div class="settings-title">üíæ Data Storage Status</div><div class="settings-description">${hasSaved?'<span style="color:#22c55e">‚úÖ Custom data saved in browser</span><br>Your uploaded data will persist across page reloads.':'<span style="color:#888">üì¶ Using default sample data</span><br>Upload an Excel file to save your own data.'}</div></div><div class="settings-card"><div class="settings-title">üì§ Upload Race Data</div><div class="settings-description">Upload Excel (.xlsx) with sheets named <strong>"2025"</strong> and/or <strong>"2026"</strong>.<br>Columns: <strong>BU, Color, Jan, Feb, Mar...</strong> (up to Dec)<br><br>üìå Data will be saved in your browser and persist after refresh.</div><div class="upload-zone" onclick="triggerFileUpload()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFileDrop(event)"><div class="upload-icon">üìÅ</div><div class="upload-text"><strong>Click to upload</strong> or drag and drop<br>Excel files (.xlsx, .xls)</div></div><div class="btn-group"><button class="btn btn-primary" onclick="downloadTemplate()">üì• Download Template</button><button class="btn btn-secondary" onclick="resetToDefault()">üîÑ Reset to Default</button></div></div><div class="settings-card"><div class="settings-title">üñºÔ∏è Custom Avatars</div><div class="settings-description">Place avatar images in the <strong>/images/</strong> folder.<br><br><strong>Naming convention:</strong> BU name in lowercase, spaces replaced with underscores<br><br><strong>Examples:</strong><br>‚Ä¢ US RET ‚Üí <code>images/us_ret.png</code><br>‚Ä¢ CAN RETAIL ‚Üí <code>images/can_retail.png</code><br>‚Ä¢ ASIA ‚Üí <code>images/asia.png</code><br><br><strong>Supported formats:</strong> PNG (recommended), JPG, GIF</div></div><div class="settings-card"><div class="settings-title">üìä Current Data - 2026</div>${p26?`<div class="data-preview">${p26}</div>`:'<div class="settings-description" style="color:#666">No data for 2026</div>'}</div><div class="settings-card"><div class="settings-title">üìä Current Data - 2025</div>${p25?`<div class="data-preview">${p25}</div>`:'<div class="settings-description" style="color:#666">No data for 2025</div>'}</div><div class="settings-card"><div class="settings-title">üìù Format Guide</div><div class="settings-description"><strong>Columns:</strong> BU (text), Color (#RRGGBB), Jan-Dec (0-100)<br><strong>Rules:</strong> Scores 0-100, valid hex colors, empty cells OK for future months<br><strong>Sheets:</strong> Must be named exactly "2025" or "2026"</div></div></div>`;}
    function handleFileDrop(e){const f=e.dataTransfer.files[0];if(f){const inp=document.getElementById('fileInput'),dt=new DataTransfer();dt.items.add(f);inp.files=dt.files;handleFileUpload({target:inp});}}
    function render(){document.getElementById('app').innerHTML=currentTab==='settings'?renderSettings():renderRace(currentTab);}
    render();
  </script>
</body>
</html>
